# <!-- Powered by BMAD™ Core -->
# Story 1.3: 后端API基础架构

## Status
Done

## Story
**作为** 后端开发人员，
**我希望** 建立RESTful API基础架构，
**以便** 提供统一的API接口和中间件支持。

## Acceptance Criteria
1. 搭建Express.js服务器和路由结构
2. 实施CORS配置和安全中间件
3. 创建统一的错误处理和日志记录机制
4. 实现API版本控制策略
5. 配置环境变量管理
6. 建立Swagger API文档框架

## Tasks / Subtasks
- [x] Task 1: 创建Express.js服务器基础结构 (AC: 1)
  - [x] 创建Express应用入口文件 (server.ts)
  - [x] 配置服务器基础设置 (端口、中间件等)
  - [x] 创建路由模块结构
  - [x] 实现健康检查端点
- [x] Task 2: 实施安全中间件 (AC: 2)
  - [x] 配置CORS中间件，允许前端域名访问
  - [x] 实现请求速率限制中间件
  - [x] 添加安全头部中间件 (helmet)
  - [x] 配置请求体解析中间件
- [x] Task 3: 创建统一的错误处理机制 (AC: 3)
  - [x] 创建自定义错误类
  - [x] 实现全局错误处理中间件
  - [x] 创建统一的API响应格式
  - [x] 实现404错误处理
- [x] Task 4: 实现日志记录机制 (AC: 3)
  - [x] 配置Winston日志记录器
  - [x] 创建请求日志中间件
  - [x] 实现错误日志记录
  - [x] 配置日志输出格式和级别
- [x] Task 5: 实现API版本控制策略 (AC: 4)
  - [x] 创建版本路由结构 (/v1/*)
  - [x] 实现API版本中间件
  - [x] 配置版本路由映射
- [x] Task 6: 完善环境变量管理 (AC: 5)
  - [x] 扩展环境变量配置文件
  - [x] 创建环境变量验证
  - [x] 实现配置对象访问模式
- [x] Task 7: 建立Swagger API文档 (AC: 6)
  - [x] 安装和配置swagger-ui-express
  - [x] 创建API文档配置
  - [x] 为路由添加Swagger注释
  - [x] 实现API文档访问端点
- [x] Task 8: 编写API基础设施测试
  - [x] 测试Express服务器启动
  - [x] 测试路由结构
  - [x] 测试错误处理中间件
  - [x] 测试日志记录功能

## Dev Notes

### Previous Story Insights
从故事1.1中获得的关键洞察：
- 项目基础结构已建立，包括apps/api目录
- TypeScript配置已完成，支持严格模式和装饰器
- Jest测试框架已配置完成
- 基础Express应用文件已存在（apps/api/src/app.ts）
- Docker配置支持容器化部署

从故事1.2中获得的关键洞察：
- 数据库连接已配置（TypeORM + MySQL）
- 数据模型已创建
- 数据库服务层已实现
- 验证中间件已实现（validation.middleware.ts）

### API Architecture Details
根据[Source: architecture/后端架构.md]，需要实现：

**路由组织结构：**
- controllers/: 控制器层，处理HTTP请求
- services/: 业务逻辑层
- models/: 数据模型层（已在故事1.2完成）
- middleware/: 中间件
- routes/: 路由定义
- utils/: 工具函数
- config/: 配置文件

**控制器模板要求：**
- 使用async/await处理异步操作
- 统一错误处理（try/catch + next(error)）
- 使用ApiResponse统一响应格式
- 遵循RESTful API设计原则

### API Specifications
根据[Source: architecture/api规范.md]，API需要：

**基础URL结构：**
- 开发环境: http://localhost:3001/v1
- 测试环境: https://staging-api.course-system.example.com/v1
- 生产环境: https://api.course-system.example.com/v1

**认证方式：**
- Bearer Token (JWT)
- API文档需要包含认证相关的端点

**响应格式要求：**
- 统一的成功响应格式
- 标准化的错误响应格式（包含code, message, details）

### Security Requirements
根据[Source: architecture/安全和性能.md]，安全要求：

**CORS配置：**
- 仅允许指定的源域名
- 开发环境允许localhost:3000
- 需要配置credentials

**安全中间件：**
- 输入验证（已有validation.middleware.ts）
- 速率限制: 100请求/15分钟窗口期
- 使用helmet设置安全头部

**认证安全：**
- JWT + Refresh Token机制（后续故事实现）
- 令牌存储: HttpOnly Cookie + CSRF保护

### Error Handling Strategy
根据[Source: architecture/错误处理策略.md]，需要实现：

**错误处理组件：**
- CustomError类实现AppError接口
- 全局错误处理中间件
- 标准错误响应格式：
  ```typescript
  interface ApiError {
    error: {
      code: string;
      message: string;
      details?: Record<string, any>;
      timestamp: string;
      requestId: string;
    };
  }
  ```

**错误日志记录：**
- 使用Winston记录详细错误信息
- 包含请求上下文（method, url, ip, userAgent）
- 开发环境返回堆栈信息

### Technology Stack Configuration
根据[Source: architecture/技术栈.md]：
- 后端框架：Express.js 4.18+
- API风格：RESTful API
- 日志：Winston
- API文档：Swagger/OpenAPI 3.0
- 中间件库：helmet, cors, express-rate-limit

### File Locations
根据[Source: architecture/统一项目结构.md]：
- 服务器入口：`apps/api/src/server.ts`
- 路由定义：`apps/api/src/routes/`
- 控制器：`apps/api/src/controllers/`
- 中间件：`apps/api/src/middleware/`
- 工具函数：`apps/api/src/utils/`
- 配置文件：`apps/api/src/config/`

### Code Standards
根据[Source: architecture/编码标准.md]：
- API路由使用kebab-case命名
- 控制器类使用PascalCase
- 中间件函数使用camelCase
- 所有类型定义放在packages/shared中
- 使用统一的ApiResponse格式

### Testing Requirements
根据[Source: architecture/测试策略.md]：
- 后端测试使用Jest + Supertest框架
- 测试文件位置：`apps/api/tests/`
- 需要测试：
  - 服务器启动和健康检查
  - 路由结构
  - 错误处理中间件
  - 日志记录功能

### Environment Configuration
根据之前的配置，需要的环境变量：
- PORT: API服务器端口（默认3001）
- NODE_ENV: 环境模式（development/production/test）
- CORS_ORIGIN: 允许的CORS源
- LOG_LEVEL: 日志级别
- JWT_SECRET: JWT密钥（用于后续认证）
- RATE_LIMIT_WINDOW: 速率限制窗口期（分钟）
- RATE_LIMIT_MAX: 窗口期内最大请求数

### Technical Constraints
- 必须使用TypeScript严格模式
- API响应时间目标：<500ms
- 错误处理必须是全局统一处理
- 所有API端点必须有适当的错误处理
- 日志记录必须包含请求上下文
- API文档必须自动生成和更新

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-15 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20251101)

### Debug Log References
- 调试日志文件: `.ai/debug-log.md`
- 应用日志目录: `apps/api/logs/`
- Winston日志配置: `apps/api/src/utils/logger.ts`

### Completion Notes List
1. 完成Express.js服务器基础架构搭建，包括服务器入口、中间件配置和路由结构
2. 实现了完整的安全中间件栈：helmet、CORS、速率限制
3. 建立了统一的错误处理机制，包含自定义错误类和全局错误处理中间件
4. 配置了Winston日志记录系统，支持结构化日志和请求追踪
5. 实现了API版本控制策略，支持/v1路由结构
6. 完善了环境变量管理，添加了配置验证
7. 集成了Swagger API文档，自动生成接口文档
8. 编写了全面的测试套件，覆盖服务器、路由、错误处理等功能

### File List
**新增/修改的文件：**
- `apps/api/src/server.ts` - 服务器入口文件
- `apps/api/src/app.ts` - Express应用配置
- `apps/api/src/config/index.ts` - 配置文件
- `apps/api/src/utils/logger.ts` - 日志工具
- `apps/api/src/middleware/errorHandler.ts` - 错误处理中间件
- `apps/api/src/middleware/notFoundHandler.ts` - 404处理中间件
- `apps/api/src/middleware/requestLogger.ts` - 请求日志中间件
- `apps/api/src/routes/v1/index.ts` - v1路由入口
- `apps/api/src/routes/v1/health.ts` - v1健康检查路由
- `apps/api/tests/server.test.ts` - 服务器测试
- `apps/api/tests/v1.test.ts` - v1路由测试
- `apps/api/tests/errorHandling.test.ts` - 错误处理测试
- `apps/api/tests/setup.ts` - 测试配置（更新）
- `apps/api/package.json` - 依赖配置（更新）
- `.env.example` - 环境变量示例（更新）

## QA Results

### Review Date: 2025-12-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

总体实现质量良好，成功建立了完整的RESTful API基础架构。所有验收标准均已实现，包括Express.js服务器、安全中间件、错误处理、日志记录、API版本控制和Swagger文档。代码结构清晰，遵循TypeScript最佳实践，测试覆盖率良好。

### Refactoring Performed

- **File**: apps/api/src/config/database.ts
  - **Change**: 统一数据库用户名环境变量名称（DB_USER → DB_USERNAME）
  - **Why**: 修复与config/index.ts和.env.example的配置不一致问题
  - **How**: 避免了潜在的数据库连接失败错误

- **File**: apps/api/src/config/database.ts
  - **Change**: 替换console.log为logger.info/error
  - **Why**: 统一日志记录方式，提供结构化日志
  - **How**: 提高了日志的一致性和可维护性

- **File**: apps/api/src/middleware/errorHandler.ts
  - **Change**: 移除MongoDB特定错误处理，添加MySQL/TypeORM错误处理
  - **Why**: 项目使用MySQL而非MongoDB，错误处理需要匹配实际数据库
  - **How**: 确保错误处理的准确性和相关性

- **File**: apps/api/src/utils/logger.ts
  - **Change**: 使用环境变量LOG_DIR配置日志目录，修复any类型使用
  - **Why**: 提高配置灵活性，避免硬编码路径，改进类型安全
  - **How**: 增强了代码的可维护性和类型安全性

- **File**: .env.example
  - **Change**: 更新JWT_SECRET默认值为更安全的提示，添加LOG_DIR配置
  - **Why**: 避免使用明显的不安全默认值，提供完整的配置选项
  - **How**: 提高了安全性配置的指导性

### Compliance Check

- Coding Standards: ✓ [整体遵循，轻微的类型定义改进]
- Project Structure: ✓ [符合统一项目结构要求]
- Testing Strategy: ✓ [测试覆盖完整，包含单元测试和集成测试]
- All ACs Met: ✓ [所有6个验收标准均已实现]

### Improvements Checklist

- [x] 统一数据库环境变量名称配置
- [x] 修复错误处理中的数据库特定代码
- [x] 改进日志路径配置的灵活性
- [x] 修复TypeScript类型安全问题
- [x] 更新环境变量示例的安全性
- [ ] 添加CSRF保护中间件
- [ ] 实现请求压缩（gzip）中间件
- [ ] 降低请求体大小限制（10mb → 1-2mb）
- [ ] 添加输入sanitization中间件
- [ ] 实现日志轮转配置

### Security Review

安全配置基础良好：
✅ 已实现helmet安全头部
✅ CORS配置正确支持环境变量
✅ 速率限制已配置（100请求/15分钟）
⚠️ 缺少CSRF保护
⚠️ 请求体大小限制过大（10mb）

### Performance Considerations

性能配置合理：
✅ 响应格式统一，支持请求ID追踪
✅ 错误处理不影响性能
✅ 日志记录异步
⚠️ 缺少响应压缩
⚠️ 未实现API缓存

### Files Modified During Review

- apps/api/src/config/database.ts
- apps/api/src/middleware/errorHandler.ts
- apps/api/src/utils/logger.ts
- .env.example

_请开发人员更新File List以包含这些修改_

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.3-backend-api-infrastructure.yml
Risk profile: qa.qaLocation/assessments/1.3-risk-20251215.md
NFR assessment: qa.qaLocation/assessments/1.3-nfr-20251215.md

### Recommended Status

[✓ Ready for Done] - 配置问题已修复，剩余为建议性改进项
(故事所有者决定最终状态)