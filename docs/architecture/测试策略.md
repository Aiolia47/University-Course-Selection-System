# 测试策略

## 测试金字塔

```
    E2E Tests
    /        \
  Integration Tests
  /            \
Frontend Unit  Backend Unit
```

## 测试组织

### 前端测试

```
apps/web/tests/
├── components/           # 组件测试
├── pages/               # 页面测试
├── hooks/               # 自定义钩子测试
├── services/            # 服务测试
├── utils/               # 工具函数测试
├── e2e/                 # 端到端测试
└── __mocks__/           # Mock文件
```

### 后端测试

```
apps/api/tests/
├── controllers/         # 控制器测试
├── services/            # 业务逻辑测试
├── models/              # 模型测试
├── middleware/          # 中间件测试
├── integration/         # 集成测试
└── fixtures/            # 测试数据
```

### E2E测试

```
tests/e2e/
├── auth/                # 认证相关测试
├── courses/             # 课程相关测试
├── selections/          # 选课相关测试
├── admin/               # 管理员功能测试
└── utils/               # 测试工具函数
```

## 测试示例

### 前端组件测试

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { Provider } from 'react-redux';
import { store } from '../../../stores/store';
import { CourseCard } from '../CourseCard';
import { Course } from '../../../types/course';

const mockCourse: Course = {
  id: '1',
  code: 'CS101',
  name: '计算机科学导论',
  description: '计算机科学基础课程',
  credits: 3,
  teacher: '张教授',
  capacity: 100,
  enrolled: 45,
  status: 'published',
  schedules: [],
  createdAt: new Date(),
  updatedAt: new Date(),
};

describe('CourseCard', () => {
  const renderWithProvider = (component: React.ReactElement) => {
    return render(
      <Provider store={store}>
        {component}
      </Provider>
    );
  };

  it('应该正确显示课程信息', () => {
    renderWithProvider(<CourseCard course={mockCourse} />);

    expect(screen.getByText('计算机科学导论')).toBeInTheDocument();
    expect(screen.getByText('CS101')).toBeInTheDocument();
    expect(screen.getByText('张教授')).toBeInTheDocument();
    expect(screen.getByText('3')).toBeInTheDocument();
    expect(screen.getByText('45/100')).toBeInTheDocument();
  });

  it('点击选择按钮应该调用onSelect回调', () => {
    const mockOnSelect = jest.fn();
    renderWithProvider(<CourseCard course={mockCourse} onSelect={mockOnSelect} />);

    const selectButton = screen.getByText('选择课程');
    fireEvent.click(selectButton);

    expect(mockOnSelect).toHaveBeenCalledWith('1');
  });
});
```

### 后端API测试

```typescript
import request from 'supertest';
import { app } from '../../src/server';
import { getRepository } from 'typeorm';
import { User } from '../../src/models/User';

describe('Auth Controller', () => {
  beforeEach(async () => {
    // 清理测试数据
    await getRepository(User).delete({});
  });

  describe('POST /auth/login', () => {
    it('应该成功登录有效的用户', async () => {
      // 创建测试用户
      const userRepository = getRepository(User);
      const testUser = userRepository.create({
        username: 'testuser',
        email: 'test@example.com',
        passwordHash: 'hashedPassword',
        role: 'student',
        status: 'active',
      });
      await userRepository.save(testUser);

      const response = await request(app)
        .post('/v1/auth/login')
        .send({
          username: 'testuser',
          password: 'password',
        })
        .expect(200);

      expect(response.body).toHaveProperty('user');
      expect(response.body).toHaveProperty('accessToken');
      expect(response.body).toHaveProperty('refreshToken');
      expect(response.body.user.username).toBe('testuser');
    });

    it('应该拒绝无效的用户名', async () => {
      const response = await request(app)
        .post('/v1/auth/login')
        .send({
          username: 'nonexistent',
          password: 'password',
        })
        .expect(401);

      expect(response.body.error.code).toBe('INVALID_CREDENTIALS');
    });
  });
});
```

### E2E测试

```typescript
import { test, expect } from '@playwright/test';

test.describe('学生选课流程', () => {
  test.beforeEach(async ({ page }) => {
    // 登录学生账户
    await page.goto('/login');
    await page.fill('[data-testid=username]', 'student001');
    await page.fill('[data-testid=password]', 'password123');
    await page.click('[data-testid=login-button]');
    await expect(page).toHaveURL('/dashboard');
  });

  test('应该能够浏览课程列表', async ({ page }) => {
    await page.click('[data-testid=courses-link]');
    await expect(page).toHaveURL('/courses');

    // 验证课程列表显示
    await expect(page.locator('[data-testid=course-card]')).toHaveCount.greaterThan(0);
  });

  test('应该能够成功选择课程', async ({ page }) => {
    await page.goto('/courses');

    // 点击第一门课程的选择按钮
    await page.click('[data-testid=course-card] [data-testid=select-button]:first-child');

    // 验证成功提示
    await expect(page.locator('[data-testid=success-message]')).toBeVisible();

    // 验证课程列表更新
    const selectedButton = page.locator('[data-testid=course-card] [data-testid=selected-button]:first-child');
    await expect(selectedButton).toBeVisible();
  });

  test('应该检测选课时间冲突', async ({ page }) => {
    // 先选择一门在周一上午的课程
    await page.goto('/courses');
    await page.click('[data-testid=course-monday-morning] [data-testid=select-button]');

    // 尝试选择另一门同样在周一上午的课程
    await page.click('[data-testid=course-monday-morning-conflict] [data-testid=select-button]');

    // 验证冲突提示
    await expect(page.locator('[data-testid=conflict-modal]')).toBeVisible();
    await expect(page.locator('[data-testid=conflict-message]')).toContainText('时间冲突');
  });
});
```
