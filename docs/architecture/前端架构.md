# 前端架构

## 组件架构

### 组件组织

```
src/
├── components/           # 可复用UI组件
│   ├── common/          # 通用组件
│   │   ├── Button/
│   │   ├── Input/
│   │   ├── Modal/
│   │   └── Loading/
│   ├── forms/           # 表单组件
│   │   ├── LoginForm/
│   │   ├── CourseForm/
│   │   └── UserForm/
│   └── layout/          # 布局组件
│       ├── Header/
│       ├── Sidebar/
│       └── Footer/
├── pages/               # 页面组件
│   ├── auth/
│   │   ├── Login.tsx
│   │   └── Register.tsx
│   ├── dashboard/
│   │   ├── StudentDashboard.tsx
│   │   └── AdminDashboard.tsx
│   ├── courses/
│   │   ├── CourseList.tsx
│   │   ├── CourseDetail.tsx
│   │   └── CourseManagement.tsx
│   ├── selections/
│   │   ├── MySelections.tsx
│   │   └── SelectionHistory.tsx
│   └── profile/
│       ├── UserProfile.tsx
│       └── UserManagement.tsx
├── hooks/               # 自定义React Hooks
│   ├── useAuth.ts
│   ├── useApi.ts
│   └── useLocalStorage.ts
├── services/            # API服务层
│   ├── api.ts
│   ├── authService.ts
│   ├── courseService.ts
│   └── selectionService.ts
├── stores/              # Redux状态管理
│   ├── slices/
│   │   ├── authSlice.ts
│   │   ├── courseSlice.ts
│   │   └── selectionSlice.ts
│   └── store.ts
├── styles/              # 样式文件
│   ├── globals.css
│   ├── variables.css
│   └── components/
├── utils/               # 工具函数
│   ├── constants.ts
│   ├── helpers.ts
│   └── validators.ts
├── types/               # TypeScript类型定义
│   ├── api.ts
│   ├── auth.ts
│   └── course.ts
└── tests/               # 测试文件
    ├── components/
    ├── pages/
    └── utils/
```

### 组件模板

```typescript
import React from 'react';
import { Button, Card, Space } from 'antd';
import { useTranslation } from 'react-i18next';
import styles from './CourseCard.module.css';

interface CourseCardProps {
  course: Course;
  onSelect?: (courseId: string) => void;
  onViewDetails?: (courseId: string) => void;
}

export const CourseCard: React.FC<CourseCardProps> = ({
  course,
  onSelect,
  onViewDetails,
}) => {
  const { t } = useTranslation();

  const handleSelect = () => {
    onSelect?.(course.id);
  };

  const handleViewDetails = () => {
    onViewDetails?.(course.id);
  };

  return (
    <Card
      className={styles.courseCard}
      title={course.name}
      extra={<span>{course.code}</span>}
      actions={[
        <Button type="link" onClick={handleViewDetails}>
          {t('common.viewDetails')}
        </Button>,
        <Button type="primary" onClick={handleSelect}>
          {t('course.select')}
        </Button>,
      ]}
    >
      <Space direction="vertical">
        <div>
          <strong>{t('course.teacher')}:</strong> {course.teacher}
        </div>
        <div>
          <strong>{t('course.credits')}:</strong> {course.credits}
        </div>
        <div>
          <strong>{t('course.capacity')}:</strong> {course.enrolled}/{course.capacity}
        </div>
        {course.description && (
          <div className={styles.description}>
            {course.description}
          </div>
        )}
      </Space>
    </Card>
  );
};

export default CourseCard;
```

## 状态管理架构

### 状态结构

```typescript
interface RootState {
  auth: AuthState;
  courses: CourseState;
  selections: SelectionState;
  ui: UIState;
}

interface AuthState {
  user: User | null;
  token: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}

interface CourseState {
  list: Course[];
  current: Course | null;
  loading: boolean;
  error: string | null;
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
  filters: CourseFilters;
}

interface SelectionState {
  list: Selection[];
  loading: boolean;
  error: string | null;
  conflicts: SelectionConflict[];
}

interface UIState {
  theme: 'light' | 'dark';
  language: string;
  sidebarCollapsed: boolean;
  notifications: Notification[];
}
```

### 状态管理模式

- **Redux Toolkit**: 用于全局状态管理
- **RTK Query**: 处理异步API调用和缓存
- **React Context**: 用于组件间状态传递
- **本地状态**: 组件内部使用useState管理

## 路由架构

### 路由组织

```
src/routes/
├── index.ts              # 路由配置入口
├── publicRoutes.tsx      # 公开路由
├── studentRoutes.tsx     # 学生路由
├── adminRoutes.tsx       # 管理员路由
├── ProtectedRoute.tsx    # 路由守卫组件
└── ErrorBoundary.tsx     # 错误边界组件
```

### 受保护路由模式

```typescript
import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useSelector } from 'react-redux';
import { RootState } from '../stores/store';

interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRole?: 'student' | 'admin';
  fallbackPath?: string;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({
  children,
  requiredRole,
  fallbackPath = '/login',
}) => {
  const { isAuthenticated, user } = useSelector((state: RootState) => state.auth);
  const location = useLocation();

  if (!isAuthenticated) {
    return <Navigate to={fallbackPath} state={{ from: location }} replace />;
  }

  if (requiredRole && user?.role !== requiredRole) {
    return <Navigate to="/unauthorized" replace />;
  }

  return <>{children}</>;
};
```

## 前端服务层

### API客户端设置

```typescript
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';
import { message } from 'antd';
import { store } from '../stores/store';
import { logout } from '../stores/slices/authSlice';

class ApiClient {
  private instance: AxiosInstance;

  constructor() {
    this.instance = axios.create({
      baseURL: process.env.REACT_APP_API_URL || 'http://localhost:3001/v1',
      timeout: 10000,
      headers: {
        'Content-Type': 'application/json',
      },
    });

    this.setupInterceptors();
  }

  private setupInterceptors() {
    // 请求拦截器
    this.instance.interceptors.request.use(
      (config) => {
        const state = store.getState();
        const token = state.auth.token;

        if (token) {
          config.headers.Authorization = `Bearer ${token}`;
        }

        return config;
      },
      (error) => Promise.reject(error)
    );

    // 响应拦截器
    this.instance.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response?.status === 401) {
          store.dispatch(logout());
          window.location.href = '/login';
        } else if (error.response?.data?.error?.message) {
          message.error(error.response.data.error.message);
        } else {
          message.error('网络错误，请稍后重试');
        }

        return Promise.reject(error);
      }
    );
  }

  public get<T = any>(url: string, config?: AxiosRequestConfig) {
    return this.instance.get<T>(url, config);
  }

  public post<T = any>(url: string, data?: any, config?: AxiosRequestConfig) {
    return this.instance.post<T>(url, data, config);
  }

  public put<T = any>(url: string, data?: any, config?: AxiosRequestConfig) {
    return this.instance.put<T>(url, data, config);
  }

  public delete<T = any>(url: string, config?: AxiosRequestConfig) {
    return this.instance.delete<T>(url, config);
  }
}

export const apiClient = new ApiClient();
```

### 服务示例

```typescript
import { apiClient } from './api';
import { Course, CourseFilters, CreateCourseRequest, UpdateCourseRequest } from '../types/course';

export const courseService = {
  // 获取课程列表
  getCourses: async (filters?: CourseFilters, page = 1, limit = 20) => {
    const params = new URLSearchParams({
      page: page.toString(),
      limit: limit.toString(),
      ...filters,
    });

    const response = await apiClient.get<{
      courses: Course[];
      pagination: any;
    }>(`/courses?${params}`);

    return response.data;
  },

  // 获取课程详情
  getCourse: async (courseId: string) => {
    const response = await apiClient.get<{ course: Course }>(`/courses/${courseId}`);
    return response.data.course;
  },

  // 创建课程
  createCourse: async (courseData: CreateCourseRequest) => {
    const response = await apiClient.post<{ course: Course }>('/courses', courseData);
    return response.data.course;
  },

  // 更新课程
  updateCourse: async (courseId: string, courseData: UpdateCourseRequest) => {
    const response = await apiClient.put<{ course: Course }>(`/courses/${courseId}`, courseData);
    return response.data.course;
  },

  // 删除课程
  deleteCourse: async (courseId: string) => {
    await apiClient.delete(`/courses/${courseId}`);
  },

  // 检查选课冲突
  checkConflicts: async (courseIds: string[]) => {
    const response = await apiClient.post<{
      hasConflicts: boolean;
      conflicts: any[];
    }>('/selections/check-conflicts', { courseIds });

    return response.data;
  },
};
```
